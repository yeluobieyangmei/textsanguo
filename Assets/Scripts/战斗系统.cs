using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using 玩家数据结构;
using 怪物数据结构;

/// <summary>
/// PVP模式枚举
/// </summary>
public enum PVP模式
{
    战场模式,  // 单次攻击，造成伤害后结束（用于王城战等战场）
    PK模式     // 回合制互砍，直至一方死亡（用于野外PK、决斗等）
}

public static class 战斗系统
{
    private const float 防御系数 = 0.5f;  // 防御减伤系数
    private const float 基础暴击率 = 0.1f;  // 10%基础暴击率
    private const float 暴击伤害倍率 = 1.5f;  // 1.5倍暴击伤害

    public static (bool 是否胜利, 怪物数据 被击败的怪物) 开始战斗(玩家数据 玩家, 怪物数据 怪物)
    {
        战斗日志管理器.实例.清空日志();
        Debug.Log($"玩家当前的生命值是：{玩家.玩家属性.当前生命值}，攻击力是：{玩家.玩家属性.攻击力}，防御力是：{玩家.玩家属性.防御力}");
        Debug.Log($"怪物当前的生命值是：{怪物.属性.当前生命值}，攻击力是：{怪物.属性.攻击力}，防御力是：{怪物.属性.防御力}");
        /*
        Debug.Log($"玩家当前的生命值是：{玩家.玩家属性.当前生命值}，攻击力是：{玩家.玩家属性.攻击力}，防御力是：{玩家.玩家属性.防御力}");
        Debug.Log($"怪物当前的生命值是：{怪物.属性.当前生命值}，攻击力是：{怪物.属性.攻击力}，防御力是：{怪物.属性.防御力}");
        Debug.Log($"=== 战斗开始 ===");
        Debug.Log($"{玩家.姓名} 对 {怪物.名称} 发起了攻击！");
        Debug.Log($"{玩家.姓名} HP:{玩家.玩家属性.当前生命值}/{玩家.玩家属性.当前生命值}");
        Debug.Log($"{怪物.名称} HP:{怪物.属性.当前生命值}");
        Debug.Log("------------------");
        */

        int 回合数 = 1;
        bool 玩家回合 = true;  // 玩家先手

        while (true)
        {
            Debug.Log($"=== 第{回合数}回合 ===");

            if (玩家回合)
            {
                // 玩家攻击
                int 玩家伤害 = 计算伤害(玩家.玩家属性.攻击力, 怪物.属性.防御力, 玩家.玩家属性.暴击率);
                怪物.属性.当前生命值 = Mathf.Max(0, 怪物.属性.当前生命值 - 玩家伤害);
                //Debug.Log($"{玩家.姓名} 对 {怪物.名称} 造成了 {玩家伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}");
                战斗日志管理器.实例.添加日志($"{玩家.姓名} 对 {怪物.名称} 造成了 {玩家伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}\n");
                if (怪物.属性.当前生命值 <= 0)
                {
                    //Debug.Log($"\n{怪物.名称} 被击败了！{玩家.姓名} 获得了 {怪物.铜钱} 铜钱 和 {怪物.经验值} 经验值！");
                    战斗日志管理器.实例.添加日志($"{怪物.名称} 被击败了！{玩家.姓名} 获得了 {怪物.铜钱} 铜钱 和 {怪物.经验值} 经验值！\n");
                    怪物管理器.回收怪物(怪物.ID);
                    return (true, 怪物);  // 返回胜利和被击败的怪物
                }
            }
            else
            {
                // 怪物攻击
                int 怪物伤害 = 计算伤害(怪物.属性.攻击力, 玩家.玩家属性.防御力, 基础暴击率);
                玩家.玩家属性.当前生命值 = Mathf.Max(0, 玩家.玩家属性.当前生命值 - 怪物伤害);
                //Debug.Log($"{怪物.名称} 对 {玩家.姓名} 造成了 {怪物伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}");
                战斗日志管理器.实例.添加日志($"{怪物.名称} 对 {玩家.姓名} 造成了 {怪物伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}\n");
                if (玩家.玩家属性.当前生命值 <= 0)
                {
                    //Debug.Log($"{玩家.姓名} 被击败了...");
                    战斗日志管理器.实例.添加日志($"{玩家.姓名} 被击败了...");
                    return (false, null);  // 返回失败，没有怪物被击败
                }
            }

            玩家回合 = !玩家回合;  // 切换回合
            if (玩家回合) 回合数++;
        }

        // 理论上不会执行到这里
        return (false, null);
    }
    /*
    private static int 计算伤害(int 攻击力, int 防御力, float 暴击率 = 0)
    {
        // 新伤害公式
        float 基础伤害 = 攻击力 * (1 - 防御力 / (防御力 + 攻击力 * 2f));
        int 最终伤害 = Mathf.Max(1, Mathf.RoundToInt(基础伤害));

        // 暴击判定
        if (Random.value < (基础暴击率 + 暴击率))
        {
            最终伤害 = Mathf.RoundToInt(最终伤害 * 暴击伤害倍率);
            战斗日志管理器.实例.添加日志("暴击！\n");
        }

        return 最终伤害;
    }
    */

    private static int 计算伤害(int 攻击力, int 防御力, float 暴击率 = 0)
    {
        // 基础伤害 = 攻击力 * (1 + 攻击力 / (防御力 + 1))
        float 基础伤害 = 攻击力 * (1 + 攻击力 / (防御力 + 1f));
        int 最终伤害 = Mathf.Max(1, Mathf.RoundToInt(基础伤害));

        // 暴击判定
        if (Random.value < (基础暴击率 + 暴击率))
        {
            最终伤害 = Mathf.RoundToInt(最终伤害 * 暴击伤害倍率);
            战斗日志管理器.实例.添加日志("暴击！\n");
        }

        return 最终伤害;
    }

    /// <summary>
    /// 玩家攻击玩家（PVP战斗）
    /// </summary>
    /// <param name="攻击者">攻击的玩家</param>
    /// <param name="被攻击者">被攻击的玩家</param>
    /// <returns>返回攻击结果信息</returns>
    public static PVP攻击结果 玩家攻击玩家(玩家数据 攻击者, 玩家数据 被攻击者)
    {
        if (攻击者 == null || 被攻击者 == null)
        {
            return new PVP攻击结果
            {
                攻击成功 = false,
                错误信息 = "攻击者或被攻击者不存在！"
            };
        }

        // 检查是否攻击同伙（如果需要的话）
        if (攻击者.家族 != null && 被攻击者.家族 != null && 攻击者.家族 == 被攻击者.家族)
        {
            return new PVP攻击结果
            {
                攻击成功 = false,
                错误信息 = "不能攻击同伙！"
            };
        }

        // 使用现有的伤害计算逻辑
        int 伤害值 = 计算伤害(攻击者.玩家属性.攻击力, 被攻击者.玩家属性.防御力, 攻击者.玩家属性.暴击率);

        // 记录被攻击者的原始生命值
        int 原始生命值 = 被攻击者.玩家属性.当前生命值;

        // 对被攻击者造成伤害
        被攻击者.玩家属性.当前生命值 = Mathf.Max(0, 被攻击者.玩家属性.当前生命值 - 伤害值);

        // 判断是否死亡
        bool 目标死亡 = 被攻击者.玩家属性.当前生命值 <= 0;

        // 记录战斗日志
        string 战斗日志 = $"{攻击者.姓名} 对 {被攻击者.姓名} 造成了 {伤害值} 点伤害！";
        if (目标死亡)
        {
            战斗日志 += $" {被攻击者.姓名} 被击败了！";
        }
        else
        {
            战斗日志 += $" {被攻击者.姓名} 剩余生命值: {被攻击者.玩家属性.当前生命值}";
        }

        Debug.Log(战斗日志);

        return new PVP攻击结果
        {
            攻击成功 = true,
            伤害值 = 伤害值,
            目标死亡 = 目标死亡,
            原始生命值 = 原始生命值,
            剩余生命值 = 被攻击者.玩家属性.当前生命值,
            战斗日志 = 战斗日志
        };
    }

    /// <summary>
    /// 简化版本：只返回伤害值，不修改玩家数据（用于预览或战场系统）
    /// </summary>
    public static int 计算PVP伤害(玩家数据 攻击者, 玩家数据 被攻击者)
    {
        if (攻击者 == null || 被攻击者 == null) return 0;

        return 计算伤害(攻击者.玩家属性.攻击力, 被攻击者.玩家属性.防御力, 攻击者.玩家属性.暴击率);
    }

    /// <summary>
    /// 检查玩家是否死亡，如果是当前操控角色则显示复活弹窗
    /// </summary>
    /// <param name="玩家">要检查的玩家</param>
    public static void 检查并处理玩家死亡(玩家数据 玩家)
    {
        if (玩家 == null) return;

        // 检查是否死亡
        if (玩家.玩家属性.当前生命值 <= 0)
        {
            Debug.Log($"检测到玩家 {玩家.姓名} 死亡");

            // 检查是否为当前操控的角色
            if (玩家.ID == 全局变量.当前身份)
            {
                Debug.Log($"当前操控角色 {玩家.姓名} 死亡，显示复活选项");
                显示死亡复活弹窗(玩家);
            }
        }
    }

    /// <summary>
    /// 显示死亡复活弹窗
    /// </summary>
    /// <param name="死亡玩家">死亡的玩家</param>
    private static void 显示死亡复活弹窗(玩家数据 死亡玩家)
    {
        Debug.Log($"显示死亡复活弹窗: {死亡玩家.姓名}");

        // 调用复活页面管理器显示弹窗
        // 你需要创建一个名为"复活页面管理器"的脚本并绑定到你的复活弹窗UI上
        // 然后取消注释下面这行：
        复活页面管理器.实例.显示死亡弹窗(死亡玩家);

        // 临时提示（创建复活页面管理器后可删除）
        //通用提示框.显示($"{死亡玩家.姓名} 已死亡！请创建复活页面管理器脚本。");
    }

    /// <summary>
    /// 完美复活（100%生命值）
    /// </summary>
    /// <param name="玩家">要复活的玩家</param>
    /// <returns>是否复活成功</returns>
    public static bool 完美复活(玩家数据 玩家)
    {
        if (玩家 == null) return false;

        const int 黄金成本 = 100;

        // 检查黄金是否足够
        if (玩家.黄金 < 黄金成本)
        {
            Debug.Log($"{玩家.姓名} 黄金不足，无法完美复活（需要 {黄金成本} 黄金，当前有 {玩家.黄金} 黄金）");
            return false;
        }

        // 扣除黄金
        玩家.黄金 -= 黄金成本;

        // 恢复到满血
        玩家.玩家属性.当前生命值 = 玩家.玩家属性.生命值;

        Debug.Log($"{玩家.姓名} 完美复活成功，消耗 {黄金成本} 黄金，恢复到满血 {玩家.玩家属性.当前生命值}");

        // 通知UI刷新列表（复活后重新显示在敌方列表中）
        通知战场UI刷新();

        return true;
    }

    /// <summary>
    /// 半血复活（50%生命值）
    /// </summary>
    /// <param name="玩家">要复活的玩家</param>
    /// <returns>是否复活成功</returns>
    public static bool 半血复活(玩家数据 玩家)
    {
        if (玩家 == null) return false;

        const int 铜钱成本 = 2000;

        // 检查铜钱是否足够
        if (玩家.铜钱 < 铜钱成本)
        {
            Debug.Log($"{玩家.姓名} 铜钱不足，无法半血复活（需要 {铜钱成本} 铜钱，当前有 {玩家.铜钱} 铜钱）");
            return false;
        }

        // 扣除铜钱
        玩家.铜钱 -= 铜钱成本;

        // 恢复到半血
        玩家.玩家属性.当前生命值 = 玩家.玩家属性.生命值 / 2;

        Debug.Log($"{玩家.姓名} 半血复活成功，消耗 {铜钱成本} 铜钱，恢复到半血 {玩家.玩家属性.当前生命值}");

        // 通知UI刷新列表（复活后重新显示在敌方列表中）
        通知战场UI刷新();

        return true;
    }

    /// <summary>
    /// 检查玩家是否可以进入战场（生命值不低于10%）
    /// </summary>
    /// <param name="玩家">要检查的玩家</param>
    /// <returns>是否可以进入战场</returns>
    public static bool 检查可以进入战场(玩家数据 玩家)
    {
        if (玩家 == null) return false;

        // 计算最低生命值阈值（10%）
        int 最低生命值 = Mathf.CeilToInt(玩家.玩家属性.生命值 * 0.1f);

        bool 可以进入 = 玩家.玩家属性.当前生命值 >= 最低生命值;

        if (!可以进入)
        {
            Debug.Log($"{玩家.姓名} 生命值过低，无法进入战场（当前: {玩家.玩家属性.当前生命值}, 最低要求: {最低生命值}）");
        }

        return 可以进入;
    }

    /// <summary>
    /// 测试用：让当前玩家死亡（用于测试复活弹窗功能）
    /// </summary>
    public static void 测试当前玩家死亡()
    {
        玩家数据 当前玩家 = 全局变量.所有玩家数据表[全局变量.当前身份];

        if (当前玩家 != null)
        {
            Debug.Log($"[测试] 让当前玩家 {当前玩家.姓名} 死亡");

            // 设置生命值为0
            当前玩家.玩家属性.当前生命值 = 0;

            // 检查并处理死亡
            检查并处理玩家死亡(当前玩家);
        }
        else
        {
            Debug.LogError("[测试] 当前玩家为空，无法测试死亡功能！");
        }
    }

    /// <summary>
    /// 通知战场UI刷新列表（用于复活后重新显示）
    /// </summary>
    private static void 通知战场UI刷新()
    {
        // 查找当前活跃的王城战战场UI
        王城战战场 战场UI = GameObject.FindObjectOfType<王城战战场>();
        if (战场UI != null && 战场UI.gameObject.activeInHierarchy)
        {
            // 刷新敌方玩家列表显示
            战场UI.刷新玩家对象列表();
            Debug.Log("复活后刷新战场UI列表");
        }
    }
}

/// <summary>
/// PVP攻击结果数据结构
/// </summary>
public struct PVP攻击结果
{
    public bool 攻击成功;        // 攻击是否成功
    public int 伤害值;           // 造成的伤害
    public bool 目标死亡;        // 目标是否死亡
    public int 原始生命值;      // 攻击前的生命值
    public int 剩余生命值;      // 攻击后的生命值
    public string 战斗日志;      // 战斗日志信息
    public string 错误信息;      // 错误信息（如果攻击失败）
}