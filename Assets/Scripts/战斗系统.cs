using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using 玩家数据结构;
using 怪物数据结构;

public static class 战斗系统
{
    private const float 防御系数 = 0.5f;  // 防御减伤系数
    private const float 基础暴击率 = 0.1f;  // 10%基础暴击率
    private const float 暴击伤害倍率 = 1.5f;  // 1.5倍暴击伤害

    public static (bool 是否胜利, 怪物数据 被击败的怪物) 开始战斗(玩家数据 玩家, 怪物数据 怪物)
    {
        战斗日志管理器.实例.清空日志();
        Debug.Log($"玩家当前的生命值是：{玩家.玩家属性.当前生命值}，攻击力是：{玩家.玩家属性.攻击力}，防御力是：{玩家.玩家属性.防御力}");
        Debug.Log($"怪物当前的生命值是：{怪物.属性.当前生命值}，攻击力是：{怪物.属性.攻击力}，防御力是：{怪物.属性.防御力}");
        /*
        Debug.Log($"玩家当前的生命值是：{玩家.玩家属性.当前生命值}，攻击力是：{玩家.玩家属性.攻击力}，防御力是：{玩家.玩家属性.防御力}");
        Debug.Log($"怪物当前的生命值是：{怪物.属性.当前生命值}，攻击力是：{怪物.属性.攻击力}，防御力是：{怪物.属性.防御力}");
        Debug.Log($"=== 战斗开始 ===");
        Debug.Log($"{玩家.姓名} 对 {怪物.名称} 发起了攻击！");
        Debug.Log($"{玩家.姓名} HP:{玩家.玩家属性.当前生命值}/{玩家.玩家属性.当前生命值}");
        Debug.Log($"{怪物.名称} HP:{怪物.属性.当前生命值}");
        Debug.Log("------------------");
        */

        int 回合数 = 1;
        bool 玩家回合 = true;  // 玩家先手

        while (true)
        {
            Debug.Log($"=== 第{回合数}回合 ===");

            if (玩家回合)
            {
                // 玩家攻击
                int 玩家伤害 = 计算伤害(玩家.玩家属性.攻击力, 怪物.属性.防御力, 玩家.玩家属性.暴击率);
                怪物.属性.当前生命值 = Mathf.Max(0, 怪物.属性.当前生命值 - 玩家伤害);
                //Debug.Log($"{玩家.姓名} 对 {怪物.名称} 造成了 {玩家伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}");
                战斗日志管理器.实例.添加日志($"{玩家.姓名} 对 {怪物.名称} 造成了 {玩家伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}\n");
                if (怪物.属性.当前生命值 <= 0)
                {
                    //Debug.Log($"\n{怪物.名称} 被击败了！{玩家.姓名} 获得了 {怪物.铜钱} 铜钱 和 {怪物.经验值} 经验值！");
                    战斗日志管理器.实例.添加日志($"{怪物.名称} 被击败了！{玩家.姓名} 获得了 {怪物.铜钱} 铜钱 和 {怪物.经验值} 经验值！\n");
                    怪物管理器.回收怪物(怪物.ID);
                    return (true, 怪物);  // 返回胜利和被击败的怪物
                }
            }
            else
            {
                // 怪物攻击
                int 怪物伤害 = 计算伤害(怪物.属性.攻击力, 玩家.玩家属性.防御力, 基础暴击率);
                玩家.玩家属性.当前生命值 = Mathf.Max(0, 玩家.玩家属性.当前生命值 - 怪物伤害);
                //Debug.Log($"{怪物.名称} 对 {玩家.姓名} 造成了 {怪物伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}");
                战斗日志管理器.实例.添加日志($"{怪物.名称} 对 {玩家.姓名} 造成了 {怪物伤害} 点伤害！玩家现在的HP是:{玩家.玩家属性.当前生命值}, 怪物的HP是：{怪物.属性.当前生命值}\n");
                if (玩家.玩家属性.当前生命值 <= 0)
                {
                    //Debug.Log($"{玩家.姓名} 被击败了...");
                    战斗日志管理器.实例.添加日志($"{玩家.姓名} 被击败了...");
                    return (false, null);  // 返回失败，没有怪物被击败
                }
            }

            玩家回合 = !玩家回合;  // 切换回合
            if (玩家回合) 回合数++;
        }

        // 理论上不会执行到这里
        return (false, null);
    }
    /*
    private static int 计算伤害(int 攻击力, int 防御力, float 暴击率 = 0)
    {
        // 新伤害公式
        float 基础伤害 = 攻击力 * (1 - 防御力 / (防御力 + 攻击力 * 2f));
        int 最终伤害 = Mathf.Max(1, Mathf.RoundToInt(基础伤害));

        // 暴击判定
        if (Random.value < (基础暴击率 + 暴击率))
        {
            最终伤害 = Mathf.RoundToInt(最终伤害 * 暴击伤害倍率);
            战斗日志管理器.实例.添加日志("暴击！\n");
        }

        return 最终伤害;
    }
    */

    private static int 计算伤害(int 攻击力, int 防御力, float 暴击率 = 0)
    {
        // 基础伤害 = 攻击力 * (1 + 攻击力 / (防御力 + 1))
        float 基础伤害 = 攻击力 * (1 + 攻击力 / (防御力 + 1f));
        int 最终伤害 = Mathf.Max(1, Mathf.RoundToInt(基础伤害));

        // 暴击判定
        if (Random.value < (基础暴击率 + 暴击率))
        {
            最终伤害 = Mathf.RoundToInt(最终伤害 * 暴击伤害倍率);
            战斗日志管理器.实例.添加日志("暴击！\n");
        }

        return 最终伤害;
    }
}
