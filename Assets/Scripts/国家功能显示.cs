using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using 玩家数据结构;
using 国家系统;

public class 国家功能显示 : MonoBehaviour
{
    public 建国脚本 建国脚本;
    public 更换国家脚本 更换国家脚本;
    public Text 国名;
    public Text 国王;
    public Text 大都督;
    public Text 丞相;
    public Text 太尉;
    public Text 御史大夫;
    public Text 金吾卫;
    public Text 成员;
    public Text 排名;
    public Text 科技;
    public Text 国库资金;
    public Text 执政家族;
    public Button 建国按钮;
    public Button 换国按钮;
    public 学习脚本 学习脚本;
    public 显示国家列表 显示国家列表;
    public 国家成员列表 国家成员列表;
    public string 王城战说明文本 = "王城战宣战将扣除1万家族资金作为报名费，王城战将由 A B两个家族争夺，战斗开始⚔后双方点击'进入主战场'按钮进入战场，进入战场后Boss每3秒可以攻击一次，等待期间可击杀对方家族玩家获取积分，最终击败Boss的家族获得Boos的归属，每3秒获得50积分。当其中任意一方积分达到1万时，则该方家族获胜，王城战结束，该家族长自动登顶王位。";


    private void OnEnable()
    {
        刷新显示();
    }
    public void 刷新显示()
    {
        玩家数据 当前玩家 = 全局变量.所有玩家数据表[全局变量.当前身份];
        国家信息库 当前国家 = 当前玩家.国家;
        国名.text = $"国 名：{当前国家.国名}({当前国家.国号})";
        国王.text = 当前国家.国王ID == -1 ? "国     王：无" : $"国     王：{全局变量.所有玩家数据表[当前国家.国王ID].姓名}";
        大都督.text = 当前国家.大都督ID == -1 ? "大 都 督：无" : $"大 都 督：{全局变量.所有玩家数据表[当前国家.大都督ID].姓名}";
        丞相.text = 当前国家.丞相ID == -1 ? "丞     相：无" : $"丞     相：{全局变量.所有玩家数据表[当前国家.丞相ID].姓名}";
        太尉.text = 当前国家.太尉ID == -1 ? "太     尉：无" : $"太     尉：{全局变量.所有玩家数据表[当前国家.太尉ID].姓名}";
        御史大夫.text = 当前国家.御史大夫ID == -1 ? "御史大夫：无" : $"御史大夫：{全局变量.所有玩家数据表[当前国家.御史大夫ID].姓名}";
        金吾卫.text = 当前国家.金吾卫ID == -1 ? "金 吾 卫：无" : $"金 吾 卫：{全局变量.所有玩家数据表[当前国家.金吾卫ID].姓名}";
        成员.text = $"成     员：{当前国家.国家成员表.Count}";
        国库资金.text = $"国库资金：{当前国家.黄金}";
        执政家族.text = 当前国家.执政家族 == null ? "执政家族：无" : $"执政家族：{当前国家.执政家族.家族名字}";
        //建国按钮.gameObject.SetActive(全局变量.所有玩家数据表[全局变量.当前身份].官职 != "国王");
        换国按钮.gameObject.SetActive(!(全局变量.所有玩家数据表[全局变量.当前身份].官职 == 官职枚举.国王));
        if (当前国家.宣战家族1 != null)
        {
            Debug.Log($"当前国家的宣战家族1是：{当前国家.宣战家族1.家族名字}");
        }
        else
        {
            Debug.Log("当前国家宣战家族1是空的");
        }
        if (当前国家.宣战家族2 != null)
        {
            Debug.Log($"当前国家的宣战家族2是：{当前国家.宣战家族2.家族名字}");
        }
        else
        {
            Debug.Log("当前国家宣战家族2是空的");
        }
    }

    public void 点击建国按钮()
    {
        建国脚本.gameObject.SetActive(true);
    }

    public void 点击换国按钮()
    {
        //更换国家脚本.gameObject.SetActive(true);
        显示国家列表.gameObject.SetActive(true);
    }

    public void 任命()
    {
        国家成员列表.当前显示类型 = 国家成员列表.显示类型.任命官员;
        国家成员列表.当前官员类型 = 国家成员列表.官员类型.大都督;
        国家成员列表.gameObject.SetActive(true);
    }

    public void 查看国家成员()
    {
        国家成员列表.当前国家 = 全局变量.所有玩家数据表[全局变量.当前身份].国家;
        国家成员列表.当前显示类型 = 国家成员列表.显示类型.不任命官员;
        国家成员列表.gameObject.SetActive(true);
    }

    public void 王城战宣战()
    {
        玩家数据 当前玩家 = 全局变量.所有玩家数据表[全局变量.当前身份];
        国家信息库 当前国家 = 当前玩家.国家;

        // 检查是否已经宣战且战场已开启
        if (当前国家.宣战家族1 != null && 当前国家.宣战家族2 != null)
        {
            // 检查战场是否已开启
            if (战场管理器.Instance != null)
            {
                战场实例 玩家战场 = 战场管理器.Instance.获取玩家战场(当前玩家);
                if (玩家战场 != null && (玩家战场.战场状态 == 战场状态.准备中 || 玩家战场.战场状态 == 战场状态.进行中))
                {
                    // 战场已开启，显示入口UI
                    显示战场入口UI();
                    return;
                }
            }

            // 战场未开启，显示已宣战信息
            通用提示框.显示($"当前已有宣战! {当前国家.宣战家族1.家族名字}VS{当前国家.宣战家族2.家族名字}");
            return;
        }
        else if (当前玩家.家族 == null)
        {
            通用提示框.显示("请先加入或创建家族!");
            return;
        }
        else if (当前玩家.家族.族长ID != 当前玩家.ID && 当前玩家.家族.副族长ID != 当前玩家.ID)
        {
            通用提示框.显示("族长或副族长才可宣战!");
            return;
        }
        //else if (当前国家.宣战家族1 != null)
        //{
        //    if (当前国家.宣战家族1.家族名字 == 当前玩家.家族.家族名字 || 当前国家.宣战家族2.家族名字 == 当前玩家.家族.家族名字)
        //    {
        //        通用提示框.显示("本家族已宣战,请等待开战!");
        //        return;
        //    }
        //}
        else if (当前玩家.家族.家族资金 < 10000)
        {
            通用提示框.显示("需1万家族资金才可宣战!");
            return;
        }
        else
        {
            通用说明弹窗.显示("王城战说明", 王城战说明文本, "宣战", 王城战确认宣战);
        }
    }

    public void 王城战确认宣战()
    {
        玩家数据 当前玩家 = 全局变量.所有玩家数据表[全局变量.当前身份];
        国家信息库 当前国家 = 当前玩家.国家;
        if (当前国家.宣战家族1 == null)
        {
            当前国家.宣战家族1 = 当前玩家.家族;
        }
        else
        {
            当前国家.宣战家族2 = 当前玩家.家族;

            // 新增：当两个家族都宣战后，启动战场管理器
            if (战场管理器.Instance != null)
            {
                战场管理器.Instance.启动王城战(当前国家, 当前国家.宣战家族1, 当前国家.宣战家族2);
            }
            else
            {
                Debug.LogError("战场管理器未找到！请确保场景中有战场管理器组件。");
            }
        }
        通用提示框.显示("宣战成功!");
    }

    public void 测试用方法()
    {
        Debug.Log("已启用测试方法");

        玩家数据 当前玩家 = 全局变量.所有玩家数据表[全局变量.当前身份];
        国家信息库 当前国家 = 当前玩家.国家;
        当前国家.宣战家族2 = 全局方法类.获取指定名字的家族("AI家族"); ;

        // 新增：当两个家族都宣战后，启动战场管理器
        if (战场管理器.Instance != null)
        {
            战场管理器.Instance.启动王城战(当前国家, 当前国家.宣战家族1, 当前国家.宣战家族2);
        }
        else
        {
            Debug.LogError("战场管理器未找到！请确保场景中有战场管理器组件。");
        }
    }

    /// <summary>
    /// 显示战场入口UI（当战场已开启时调用）
    /// </summary>
    private void 显示战场入口UI()
    {
        // 查找战场入口管理器
        战场入口管理器 入口管理器 = GameObject.FindObjectOfType<战场入口管理器>();

        if (入口管理器 != null)
        {
            // 直接显示战场入口UI
            入口管理器.手动打开战场();
            Debug.Log("通过宣战按钮显示战场入口UI");
        }
        else
        {
            // 如果没有战场入口管理器，直接进入战场
            直接进入战场();
        }
    }

    /// <summary>
    /// 直接进入战场（备用方案）
    /// </summary>
    private void 直接进入战场()
    {
        玩家数据 当前玩家 = 全局变量.所有玩家数据表[全局变量.当前身份];

        if (战场管理器.Instance != null)
        {
            战场实例 玩家战场 = 战场管理器.Instance.获取玩家战场(当前玩家);
            if (玩家战场 != null)
            {
                // 尝试进入战场
                if (战场管理器.Instance.玩家进入战场(玩家战场.战场ID, 当前玩家))
                {
                    通用提示框.显示("成功进入战场！");

                    // 打开战场主界面
                    王城战战场 战场UI = GameObject.FindObjectOfType<王城战战场>();
                    if (战场UI != null)
                    {
                        战场UI.gameObject.SetActive(true);
                    }
                }
                else
                {
                    通用提示框.显示("进入战场失败！");
                }
            }
            else
            {
                通用提示框.显示("未找到可参与的战场");
            }
        }
    }
}